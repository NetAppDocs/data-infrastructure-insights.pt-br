---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: kubernetes, Kubernetes, k8s, telegraf, installation, install, agent, telegraf agent, eks, operator 
summary: O operador de monitoramento do Kubernetes coleta dados do Kubernetes para uso no Data Infrastructure Insights. 
---
= Instalação e configuração do operador de monitoramento Kubernetes
:hardbreaks:
:allow-uri-read: 
:nofooter: 


[role="lead"]
O Data Infrastructure Insights oferece a coleção *Operador de Monitoramento do Kubernetes* para Kubernetes. Navegue até *Kubernetes > Collectors > Kubernetes Collector* para implantar um novo operador.



== Antes de instalar o operador de monitoramento do Kubernetes

Consulte link:pre-requisites_for_k8s_operator.html["Pré-requisitos"]a documentação antes de instalar ou atualizar o Operador de Monitoramento do Kubernetes.



== Instalando o Operador de Monitoramento do Kubernetes

image:NKMO-Instructions-1.png["Instruções do operador de monitorização"] image:NKMO-Instructions-2.png["Instruções do operador de monitorização"]

.Etapas para instalar o agente do operador de monitoramento do Kubernetes no Kubernetes:
. Insira um nome de cluster e um namespace exclusivos. Se você <<a atualizar,a atualizar>> é de um operador Kubernetes anterior, use o mesmo nome de cluster e namespace.
. Uma vez que eles são inseridos, você pode copiar o snippet de comando de download para a área de transferência.
. Cole o snippet em uma janela _bash_ e execute-o. Os ficheiros de instalação do Operador serão transferidos. Observe que o snippet tem uma chave exclusiva e é válido por 24 horas.
. Se você tiver um repositório personalizado ou privado, copie o trecho opcional Image Pull, cole-o em um shell _bash_ e execute-o. Depois que as imagens tiverem sido puxadas, copie-as para o seu repositório privado. Certifique-se de manter as mesmas tags e estrutura de pastas. Atualize os caminhos em _operator-deployment.yaml_, bem como as configurações do repositório docker em _operator-config.yaml_.
. Se desejar, revise as opções de configuração disponíveis, como proxy ou configurações de repositório privado. Você pode ler mais sobre link:telegraf_agent_k8s_config_options.html["opções de configuração"].
. Quando estiver pronto, implante o Operador copiando o snippet de aplicação kubectl, baixando-o e executando-o.
. A instalação prossegue automaticamente. Quando estiver concluído, clique no botão _Next_.
. Quando a instalação estiver concluída, clique no botão _Next_. Certifique-se também de excluir ou armazenar com segurança o arquivo _operator-secrets.yaml_.


Se estiver usando um proxy, leia sobre <<configuring-proxy-support,configurando proxy>>.

Se você tiver um repositório personalizado, leia sobre <<using-a-custom-or-private-docker-repository,usando um repositório docker personalizado/privado>>.



== Componentes de monitoramento do Kubernetes

O monitoramento do Kubernetes do Data Infrastructure Insights é composto por quatro componentes de monitoramento:

* Métricas do cluster
* Desempenho de rede e mapa (opcional)
* Registos de eventos (opcional)
* Análise de mudança (opcional)


Os componentes opcionais acima são ativados por padrão para cada coletor do Kubernetes; se você decidir que não precisa de um componente para um coletor específico, você pode desativá-lo navegando para *Kubernetes > coletores* e selecionando _Modificar implantação_ no menu "três pontos" do coletor à direita da tela.

image:KubernetesModifyDeploymentMenu.png["Modifique o menu de implantação na página de lista do Kubernetes Collector"]

O ecrã mostra o estado atual de cada componente e permite desativar ou ativar componentes para esse coletor, conforme necessário.

image:KubernetesModifyDeploymentScreen.png["Modifique as opções de implantação, largura de 700 mm"]



== Atualização para o operador de monitoramento mais recente do Kubernetes



=== Atualizações de botão DII

Você pode atualizar o operador de monitoramento Kubernetes pela página coletores do Kubernetes DII. Clique no menu ao lado do cluster que deseja atualizar e selecione _Upgrade_. O operador verificará as assinaturas da imagem, executará um instantâneo da sua instalação atual e executará a atualização. Dentro de alguns minutos, você deve ver o progresso do status do operador através da atualização em andamento para o mais recente. Se encontrar um erro, pode selecionar o estado de erro para obter mais detalhes e consultar a tabela de resolução de problemas de atualizações por botão abaixo.



==== Atualizações por botão com repositórios privados

Se o seu operador estiver configurado para usar um repositório privado, certifique-se de que todas as imagens necessárias para executar o operador e suas assinaturas estão disponíveis no seu repositório. Se você encontrar um erro durante o processo de atualização para imagens ausentes, basta adicioná-las ao seu repositório e tentar novamente a atualização. Para carregar as assinaturas de imagem para o seu repositório, utilize a ferramenta de cografia da seguinte forma, certificando-se de carregar assinaturas para todas as imagens especificadas em 3 Opcional: Carregue as imagens do operador para o seu repositório privado > fragmento de puxar imagem

[listing]
----
cosign copy example.com/src:v1 example.com/dest:v1
#Example
cosign copy <DII container registry>/netapp-monitoring:<image version> <private repository>/netapp-monitoring:<image version>
----


==== Voltando para uma versão em execução anterior

Se você atualizou usando o recurso de atualizações por botão e encontrar quaisquer dificuldades com a versão atual do operador dentro de sete dias da atualização, você pode fazer o downgrade para a versão em execução anterior usando o snapshot criado durante o processo de atualização. Clique no menu ao lado do cluster que você gostaria de reverter e selecione _voltar_.



=== Atualizações manuais

Determine se existe um AgentConfiguration com o Operador existente (se o seu namespace não for o _NetApp-monitoring_ padrão, substitua o namespace apropriado):

 kubectl -n netapp-monitoring get agentconfiguration netapp-monitoring-configuration
Se existir uma configuração AgentConfiguration:

* <<installing-the-kubernetes-monitoring-operator,Instale>> O operador mais recente sobre o operador existente.
+
** Certifique-se de que está <<using-a-custom-or-private-docker-repository,puxando as imagens mais recentes do recipiente>> se estiver a utilizar um repositório personalizado.




Se o AgentConfiguration não existir:

* Anote o nome do cluster conforme reconhecido pelo Data Infrastructure Insights (se o namespace não for o monitoramento padrão do NetApp, substitua o namespace apropriado):
+
 kubectl -n netapp-monitoring get agent -o jsonpath='{.items[0].spec.cluster-name}'
* Crie uma cópia de segurança do Operador existente (se o seu namespace não for o NetApp-monitoring predefinido, substitua o namespace apropriado):
+
 kubectl -n netapp-monitoring get agent -o yaml > agent_backup.yaml
* <<to-remove-the-kubernetes-monitoring-operator,Desinstalar>> O operador existente.
* <<installing-the-kubernetes-monitoring-operator,Instale>> O operador mais recente.
+
** Use o mesmo nome de cluster.
** Depois de baixar os arquivos YAML do Operador mais recentes, coloque as personalizações encontradas no Agent_backup.yaml para o operador-config.yaml baixado antes de implantar.
** Certifique-se de que está <<using-a-custom-or-private-docker-repository,puxando as imagens mais recentes do recipiente>> se estiver a utilizar um repositório personalizado.






== Parando e iniciando o Operador de Monitoramento do Kubernetes

Para parar o operador de monitoramento do Kubernetes:

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=0
Para iniciar o operador de monitoramento do Kubernetes:

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=1


== Desinstalação



=== Para remover o operador de monitoramento do Kubernetes

Observe que o namespace padrão para o Operador de Monitoramento do Kubernetes é "NetApp-monitoring". Se você tiver definido seu próprio namespace, substitua esse namespace nesses e todos os comandos e arquivos subsequentes.

As versões mais recentes do operador de monitoramento podem ser desinstaladas com os seguintes comandos:

....
kubectl -n <NAMESPACE> delete agent -l installed-by=nkmo-<NAMESPACE>
kubectl -n <NAMESPACE> delete clusterrole,clusterrolebinding,crd,svc,deploy,role,rolebinding,secret,sa -l installed-by=nkmo-<NAMESPACE>
....
Se o operador de monitoramento foi implantado em seu próprio namespace dedicado, exclua o namespace:

 kubectl delete ns <NAMESPACE>
Nota: Se o primeiro comando retornar "nenhum recurso encontrado", use as instruções a seguir para desinstalar versões mais antigas do operador de monitoramento.

Execute cada um dos seguintes comandos em ordem. Dependendo da instalação atual, alguns desses comandos podem retornar mensagens 'objeto não encontrado'. Essas mensagens podem ser ignoradas com segurança.

....
kubectl -n <NAMESPACE> delete agent netapp-ci-agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl -n <NAMESPACE> delete role netapp-ci-agent-manager netapp-ci-kube-state-metrics
kubectl delete clusterrole netapp-ci-<NAMESPACE>-additional-permissions netapp-ci-<NAMESPACE>-agent-manager netapp-ci-<NAMESPACE>-agent-secret netapp-ci-<NAMESPACE>-agent-view-plus netapp-ci-<NAMESPACE>-change-observer-view-plkubectl get us netapp-ci-<NAMESPACE>-kube-state-metrics netapp-ci-<NAMESPACE>-net-observerkubectl
kubectl delete clusterrolebinding netapp-ci-<NAMESPACE>-additional-permissions netapp-ci-<NAMESPACE>-agent-manager netapp-ci-<NAMESPACE>-agent-secret netapp-ci-<NAMESPACE>-agent-view netapp-ci-<NAMESPACE>-agent-view-plus netapp-ci-<NAMESPACE>-change-observer-additional-permissions netapp-ci-<NAMESPACE>-change-observer-secret netapp-ci-<NAMESPACE>-change-observer-view netapp-ci-<NAMESPACE>-change-observer-view-plus netapp-ci-<NAMESPACE>-event-exporter netapp-ci-<NAMESPACE>-kube-state-metrics netapp-ci-<NAMESPACE>-net-observer
kubectl delete netapp-ci-<NAMESPACE>-psp-nkmo
kubectl delete ns <NAMESPACE>
....
Se uma restrição de contexto de segurança foi criada anteriormente:

 kubectl delete scc telegraf-hostaccess


== Sobre o Kube-State-metrics

O Operador de Monitoramento do Kubernetes do NetApp instala suas próprias métricas de estado do kube para evitar conflitos com outras instâncias.

Para obter informações sobre métricas Kube-State, link:task_config_telegraf_kubernetes.html["esta página"]consulte .



=== Contadores de métricas de estado-kube

Use os seguintes links para acessar informações para esses contadores de métricas de estado do kube:

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["Métricas do ConfigMap"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["Métricas DaemonSet"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["Métricas de implantação"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["Métricas de entrada"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["Métricas de namespace"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["Métricas do nó"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["Métricas de volume persistente"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["Métricas de reclamação de volume persistentes"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["Métricas do pod"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["Métricas do ReplicaSet"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["Métricas secretas"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["Métricas de serviço"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["Métricas StatefulSet"]


'''